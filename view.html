<html>
<head>
<style type="text/css">
html, body, #map-canvas { height: 100%; margin: 0; padding: 0;}
</style>
<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js"></script>
<script type="text/javascript" src="js/CanvasLayer.js"></script>
<script type="text/javascript" src="js/TimeSlider.js"></script>
<link href="css/jquery-ui/smoothness/jquery-ui.custom.css" media="screen" rel="stylesheet" type="text/css" />
<link rel="stylesheet" href="css/rrssb.css" />
<link type="text/css" href="local-css/defaultUI.css" rel="stylesheet"></link>
<style>
.timelineSliderFiller {
  right: 33%;
}
.explorablesLogo {
  right: 320px;
}
</style>
<script src="jquery/1.11.1/jquery.min.js"></script>
<script src="js/jquery/jquery-ui.custom.min.js" type="text/javascript"></script>
<script>
var sites = 
{"32": {"SONICWS_MPH": [2.5, 2, 1.8, 1.5, 1.4, 2, 2.5, 3.3, 3.6, 4, 4.8, 6.4, 5.9, 5.4, 5.6, 6.1, 6.7, 6.2, 5.9, 7.4, 8.7, 8.4, 8.7, 8.6], "longitude": -80.169943, "SONICWD_DEG": [337, 330, 230, 264, 210, 222, 173, 202, 185, 198, 218, 231, 235, 235, 232, 237, 236, 245, 242, 251, 245, 247, 245, 243], "latitude": 40.375644, "id": 32, "name": "South Fayette ACHD"}, "1": {"SONICWS_MPH": [1.3, 1.7, 1.5, 1.5, 1.4, 1.7, 1.3, 1.2, 1.5, 1.8, 3.2, 3.6, 3.9, 4.6, 4.2, 4.2, 3.6, 5.7, 4.1, 7.3, 6.8, 7.3, 6.1, 5], "longitude": -80.071337, "PM25B_UG_M3": [22, 17, 17, 16, 23, 20, 16, 20, 27, 34, 19, 30, 25, 22, 19, 26, 24, 21, 21, 16, 18, 20, 24, 36], "SONICWD_DEG": [330, 5, 352, 341, 6, 5, 75, 301, 175, 172, 164, 255, 253, 212, 203, 222, 226, 262, 250, 258, 255, 254, 255, 225], "latitude": 40.499767, "id": 1, "name": "Avalon ACHD"}, "34": {"latitude": 40.43743055555555, "id": 34, "longitude": -79.86357222222222, "name": "Near Road ACHD"}, "3": {"SONICWS_MPH": [1.3, 1, 0.8, 0.8, 1.7, 1.1, 2.1, 1.7, 2.9, 3.2, 2.4, 2.4, 3.5, 3.2, 3.9, 3.6, 3.4, 2.6, 3.3, 2.8, 3.6, 4.9, 5, 3.7], "longitude": -79.860973, "PM10B_UG_M3": [23, 21, 29, 58, 67, 86, 52, 66, 64, 66, 56, 43, 65, 40, 45, 30, 34, 33, 40, 35, 35, 27, 34, 32], "SONICWD_DEG": [66, 64, 68, 44, 108, 104, 119, 137, 130, 148, 197, 247, 227, 226, 182, 195, 180, 209, 235, 239, 257, 265, 263, 226], "latitude": 40.402328, "id": 3, "name": "North Braddock ACHD"}, "33": {"latitude": 40.441111, "id": 33, "longitude": -80.26730277777779, "name": "West Allegheny ACHD"}, "43": {"SONICWS_MPH": [0.9, 0.7, 0.5, 0.4, 0.4, 0.5, 1.1, 1, 2.7, 3.9, 3.4, 4.9, 5.1, 5.1, 5.6, 5.7, 4.1, 3.9, 5.2, 5.7, 7.2, 6.6, 6.3, 6.9], "longitude": -79.86357222222222, "SONICWD_DEG": [192, 55, 118, 41, 191, 194, 121, 143, 179, 201, 213, 224, 213, 220, 229, 225, 208, 245, 240, 237, 241, 248, 252, 243], "latitude": 40.43743055555555, "id": 43, "name": "Parkway East Near Road ACHD"}, "35": {"latitude": 40.43743055555555, "id": 35, "longitude": -79.86357222222222, "name": "Parkway East Near Road ACHD"}, "22": {"latitude": 40.438632, "id": 22, "longitude": -80.002543, "name": "Court House ACHD"}, "23": {"latitude": 40.443367, "PM10_UG_M3": [17, 19, 23, 23, 23, 25, 23, 31, 27, 35, 41, 38, 34, 26, 26, 27, 38, 41, 30, 31, 27, 23, 21, 14], "id": 23, "longitude": -79.990293, "name": "Flag Plaza ACHD"}, "24": {"latitude": 40.326008, "PM10_UG_M3": [15, 16, 48, 25, 17, 41, 45, 60, 76, 42, 21, 17, 16, 17, 19, 19, 18, 21, 20, 19, 17, 17, 17, 15], "id": 24, "longitude": -79.881703, "name": "Glassport High Street ACHD"}, "25": {"latitude": 40.613949, "id": 25, "longitude": -79.72941, "name": "Harrison Township ACHD"}, "26": {"RWD_DEG": [318, 6, 341, 345, 348, 355, 355, 352, 329, 147, 196, 239, 252, 204, 219, 216, 234, 239, 221, 232, 228, 237, 237, 230], "SONICWS_MPH": [1.6, 1.5, 1.5, 1.5, 1.2, 1.6, 1.8, 1.6, 1.6, 1.8, 2.6, 4.8, 4.7, 5.9, 5.4, 5.9, 4.9, 7.1, 6.7, 6.6, 9.6, 8.1, 8.8, 6.8], "PM25_2__UG_M3": [16, 16, 19, 17, 18, 19, 20, 28, 24, 22, 19, 17, 16, 17, 16, 14, 16, 19, 17, 20, 18, 19, 18, 17], "longitude": -79.960757, "name": "Lawrenceville ACHD", "PM25B_UG_M3": [17, 18, 21, 21, 19, 23, 20, 30, 22, 27, 25, 29, 21, 25, 14, 14, 19, 20, 21, 16, 18, 20, 18, 20], "PM10B_UG_M3": [26, 23, 27, 29, 28, 27, 31, 44, 41, 60, 56, 58, 41, 44, 33, 34, 43, 37, 38, 34, 31, 29, 22, 26], "SONICWD_DEG": [319, 5, 341, 345, 347, 357, 354, 354, 330, 153, 198, 233, 253, 204, 217, 218, 235, 240, 220, 233, 228, 237, 237, 230], "latitude": 40.46542, "id": 26, "PM25_UG_M3": [11, 11, 13, 12, 12, 14, 14, 20, 17, 15, 13, 12, 11, 11, 11, 9, 11, 13, 11, 14, 13, 13, 12, 12], "RWS_MPH": [1.5, 1.3, 1.4, 1.3, 1.1, 1.5, 1.8, 1.3, 1.5, 1.2, 2.1, 4, 4.2, 4.9, 4.8, 5.2, 4.5, 6.8, 6.4, 6.4, 9.3, 7.7, 8.5, 6.6]}, "28": {"SONICWS_MPH": [1.2, 1.3, 3.9, 2.6, 1.8, 1.4, 1.7, 0.9, 3, 4.3, 3.8, 5.6, 4.1, 5.4, 6.3, 6.2, 4.6, 5.6, 6.2, 7.1, 9.4, 11.2, 9.2, 8.7], "PM10_UG_M3": [16, 22, 44, 44, 36, 48, 30, 28, 38, 40, 35, 24, 27, 16, 22, 28, 18, 21, 22, 15, 18, 18, 17, 15], "PM25_2__UG_M3": [14, 20, 36, 35, 31, 38, 26, 25, 31, 35, 27, 17, 15, 14, 13, 17, 16, 19, 15, 15, 15, 15, 16, 15], "longitude": -79.868062, "SONICWD_DEG": [319, 283, 195, 217, 215, 208, 122, 246, 179, 189, 208, 216, 203, 194, 185, 203, 216, 226, 225, 228, 237, 236, 240, 235], "latitude": 40.323768, "id": 28, "PM25_UG_M3": [11, 16, 29, 28, 24, 30, 21, 20, 25, 28, 22, 13, 11, 11, 9, 13, 12, 14, 12, 12, 11, 12, 13, 12], "name": "Liberty ACHD"}, "30": {"name": "Lincoln ACHD", "PM10_UG_M3": [19, 56, 34, 38, 36, 21, 25, 40, 30, 35, 31, 31, 25, 21, 20, 25, 24, 36, 43, 42, 36, 35, 41, 32], "longitude": -79.869134, "latitude": 40.308219, "id": 30, "PM25_UG_M3": [14, 39, 24, 26, 26, 18, 17, 27, 21, 24, 21, 19, 16, 14, 13, 17, 17, 23, 24, 24, 23, 23, 26, 21]}, "31": {"latitude": 40.450099, "PM10B_UG_M3": [21, 18, 18, 17, 27, 25, 35, 30, 32, 33, 39, 37, 34, 29, 32, 32, 27, 33, 38, 22, 25, 23, 17, 17], "id": 31, "longitude": -79.770957, "name": "Monroeville ACHD"}};

var resolutionScale = window.devicePixelRatio || 1;
var map;
var canvasLayer;
var context;
var timeSlider;
var displayArrows = false;

function initialize() {
  // Fudge Glassport to the west
  sites['24']['longitude'] -= 0.003;

  // Fudge Liberty to the east
  sites['28']['longitude'] += 0.003;

  // Flip Lincoln
  sites['30']['flip_y'] = 1;

  // Create an array of styles.
  var styles = [
    {
      "featureType": "road",
      "elementType": "labels",
      "stylers": [
        { "visibility": "off" }
      ]
    },
    {
      "featureType": "road.highway",
      "stylers": [
        { "color": "#aaaaaa" },
        { "weight": 0.6 }
      ]
    },
    {
      "featureType": "road.arterial",
      "stylers": [
        { "color": "#cccccc" },
        { "weight": 0.3 }
      ]
    },
    {
      "featureType": "road.local",
      "stylers": [
        { "visibility": "off" }
      ]
    },
    {
      "featureType": "poi",
      "stylers": [
        { "visibility": "off" }
      ]
    },
    {
      "featureType": "landscape",
      "stylers": [
        { "visibility": "on" },
        { "lightness": 90 }
      ]
    },
    {
      "featureType": "water",
      "stylers": [
        { "lightness": 60 }
      ]
    },
    {
      "featureType": "transit",
      "stylers": [
        { "visibility": "off" }
      ]
    },
    {
      "featureType": "administrative",
      "stylers": [
        { "visibility": "on" },
        { "lightness": 40 }
      ]
    }
  ];

  // Create a map object, and include the MapTypeId to add
  // to the map type control.
  var mapOptions = {
    zoom: 12,
    center: new google.maps.LatLng(40.38, -79.88),
    styles: styles
  };

  map = new google.maps.Map(document.getElementById('map-canvas'),
    mapOptions);

  // initialize the canvasLayer
  var canvasLayerOptions = {
    map: map,
    resizeHandler: resize,
    animate: false,
    updateHandler: update,
    resolutionScale: resolutionScale
  };
  canvasLayer = new CanvasLayer(canvasLayerOptions);
  context = canvasLayer.canvas.getContext('2d');
  window.addEventListener('resize', function () {  google.maps.event.trigger(map, 'resize') }, false);

  timeSlider = new TimeSlider({
    startTime: 1423630800000+1800000,
    endTime:   1423717200000-1800000,
    increment: 3600000,
    formatCurrentTime: function(date) {
      return new Date(date - 3600 * 1000 * 5).toUTCString().replace(':00 GMT', '');
    },
    onChange: function(slider, date) {
      // Redraw CanvasLayer
      update();
    },
    animationRate: {
      fast: 20,
      medium: 40,
      slow: 80
    }
  });
  $('.playbackButton').hide();
  $('.toggleSpeed').hide();
  $('.explorablesLogo').hide();

  $('#show_wind').change(function() {
    displayArrows = $(this).is(':checked');
    update();
  });
}

function resize() {
}

function find_channel(site, prefix) {
  var best = '';
  var vals = null;
  for (var channel in site) {
    if (site.hasOwnProperty(channel)) {
      if (channel.substring(0, prefix.length) == prefix) {
        if (best == '' || channel < best) {
          best = channel;
          vals = site[channel];
        }
      }
    }
  }
  //if (vals) console.log(site['name'] + ' using ' + best)
  return vals;
}

function find_channel_suffix(site, suffix) {
  var best = '';
  var vals = null;
  for (var channel in site) {
    if (site.hasOwnProperty(channel)) {
      if (channel.substring(channel.length - suffix.length, channel.length) == suffix) {
        if (best == '' || channel < best) {
          best = channel;
          vals = site[channel];
        }
      }
    }
  }
  //if (vals) console.log(site['name'] + ' using ' + best)
  return vals;
}

function find_pm25(site) {
  var best = '';
  var vals = null;
  for (var channel in site) {
    if (site.hasOwnProperty(channel)) {
      if (channel.substring(0, 4) == 'PM25') {
        if (best == '' || channel < best) {
          best = channel;
          vals = site[channel];
        }
      }
    }
  }
  if (vals) console.log(site['name'] + ' using ' + best);
  return vals;
}

function update() {
  var canvasWidth = canvasLayer.canvas.width;
  var canvasHeight = canvasLayer.canvas.height;
  context.setTransform(1, 0, 0, 1, 0, 0);
  context.clearRect(0, 0, canvasWidth, canvasHeight);

  /* We need to scale and translate the map for current view.
   * see https://developers.google.com/maps/documentation/javascript/maptypes#MapCoordinates
   */
  var mapProjection = map.getProjection();

  /**
   * Clear transformation from last update by setting to identity matrix.
   * Could use context.resetTransform(), but most browsers don't support
   * it yet.
   */
  
  // scale is just 2^zoom
  // If canvasLayer is scaled (with resolutionScale), we need to scale by
  // the same amount to account for the larger canvas.
  var scale = Math.pow(2, map.zoom) * resolutionScale / 1000.0;
  context.scale(scale, scale);

  /* If the map was not translated, the topLeft corner would be 0,0 in
   * world coordinates. Our translation is just the vector from the
   * world coordinate of the topLeft corder to 0,0.
   */
  var offset = mapProjection.fromLatLngToPoint(canvasLayer.getTopLeft());
  context.translate(-offset.x * 1000, -offset.y * 1000);
  //console.log('---');
  for (var site_id in sites) {
    if (sites.hasOwnProperty(site_id)) {
      var site = sites[site_id];
      var rectLatLng = new google.maps.LatLng(site.latitude, site.longitude);
      var worldPoint = mapProjection.fromLatLngToPoint(rectLatLng);
      var x = worldPoint.x * 1000;
      var y = worldPoint.y * 1000;
      var rectWidth = 0.01;
      var i = (timeSlider.getCurrentTime() - (1423630800000+1800000)) / 3600000;

      var bar_width = 5;
      var bar_scale = 0.5;
      context.font = '4px Arial';

      y_scale = site['flip_y'] ? -1 : 1;

      var pm25 = find_channel(site, 'PM25');
      if (pm25) {
        context.fillStyle = 'rgba(230, 120, 26, 1)';
        context.fillRect(x - bar_width, y, bar_width, -bar_scale * pm25[i] * y_scale);
        context.strokeStyle = 'black';
        context.lineWidth = 1.0 / scale;
        context.strokeRect(x - bar_width, y, bar_width, -bar_scale * pm25[i] * y_scale);
        context.fillStyle = 'rgba(172, 90, 20, 1)';
        context.fillText(pm25[i], x - bar_width - 0.1, y + y_scale * 2.2 + 1.5);
      }

      var pm10 = find_channel(site, 'PM10');
      if (pm10) {
        context.fillStyle = 'rgba(255, 0, 0, 1)';
        context.fillRect(x, y, bar_width, -bar_scale * pm10[i] * y_scale);
        context.strokeStyle = 'black';
        context.lineWidth = 1.0 / scale;
        context.strokeRect(x, y, bar_width, -bar_scale * pm10[i] * y_scale);
        context.fillStyle = 'rgba(200, 0, 0, 1)';
        context.fillText(pm10[i], x + 0.5, y + y_scale * 2.2 + 1.5);
      }

      var wind_speed = find_channel_suffix(site, 'WS_MPH');
      var wind_dir = find_channel_suffix(site, 'WD_DEG');
      // How to interpret wind direction:
      // Avalon, when smelly, tends to have winds from the West or Southwest
      // Fri 13 Feb 2015, 16:00, WSW, heading 246
      // Direction wind is coming _from_
      //    0
      // 270 90
      //   180

      if (displayArrows && wind_speed && wind_dir) {
        if (wind_speed[i] > 1) {
          var wind_dir_radians = wind_dir[i] * Math.PI / 180;
          var dx = -Math.sin(wind_dir_radians);
          var dy =  Math.cos(wind_dir_radians);
          var d = 1;
          context.strokeStyle = '#0000ee';
          context.lineWidth = Math.max(2.0 / scale, d * 0.75);
          context.beginPath();
          context.moveTo(x, y);
          context.lineTo(x + (wind_speed[i] * 2 - d * 1) * dx,
                         y + (wind_speed[i] * 2 - d * 1) * dy);
          context.stroke();

          context.fillStyle = '#0000ee';
          context.beginPath();
          context.moveTo(x + wind_speed[i] * 2 * dx,
                         y + wind_speed[i] * 2 * dy);
          context.lineTo(x + (wind_speed[i] * 2 - d * 3) * dx + d * 1.5 * dy,
                         y + (wind_speed[i] * 2 - d * 3) * dy - d * 1.5 * dx);
          context.lineTo(x + (wind_speed[i] * 2 - d * 3) * dx - d * 1.5 * dy,
                         y + (wind_speed[i] * 2 - d * 3) * dy + d * 1.5 * dx);
          context.fill();
        }
      }

      if (pm25 || pm10 || (displayArrows && wind_speed && wind_dir)) {
        context.fillStyle = 'black';
        context.beginPath();
        context.arc(x, y, 1, 0, 2 * Math.PI, false);
        context.fill();
      }
    }
  }
}

google.maps.event.addDomListener(window, 'load', initialize);

</script>
</head>
<body>
<div id="map-canvas"></div>
<div id="time-slider-controls"></div>
<div id="controls" style="position:absolute; bottom:30px; right:20px; padding:5px; border-radius:3px; background-color:white; border: 1px solid black"><input type="checkbox" id="show_wind"> Show Wind</div>
<!-- <div style="position:absolute; bottom:0px; height:80px; width:100%; background-color:grey; opacity:0.25;"></div> -->
</body>
</html>
